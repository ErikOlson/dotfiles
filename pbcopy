#!/bin/bash
set -e

echo "ğŸš€ Starting bootstrap process..."

# --- Homebrew ---
if ! command -v brew >/dev/null 2>&1; then
    echo "ğŸ§ª Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Ensure Homebrew is available in this shell
    eval "$(/opt/homebrew/bin/brew shellenv)"

    # Add to .zprofile if not already present
    if ! grep -q 'brew shellenv' "$HOME/.zprofile" 2>/dev/null; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> "$HOME/.zprofile"
        echo "âœ… Added Homebrew to .zprofile"
    else
        echo "â„¹ï¸  Homebrew shellenv already present in .zprofile"
    fi
else
    echo "âœ… Homebrew already installed."
fi

# --- Nix ---
if ! command -v nix >/dev/null 2>&1; then
    echo "ğŸ§ª Installing Nix..."
    curl -L https://nixos.org/nix/install | sh

    # Try sourcing the environment immediately
    if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        echo "ğŸ”„ Sourcing Nix environment into current shell..."
        source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    else
        echo "âš ï¸  Nix profile not found â€” open a new terminal session if needed."
    fi
else
    echo "âœ… Nix already installed."
fi

# --- Install Brewfile packages ---
echo "ğŸ“¦ Installing Brewfile packages..."
brew bundle --file="$HOME/dotfiles/Brewfile"

# --- Symlink configs and set script permissions ---
cd "$HOME/dotfiles"
./setup.sh

# --- Enable direnv-based global dev shell ---
if command -v direnv >/dev/null 2>&1; then
    if [ ! -f "$HOME/.envrc" ]; then
        echo "ğŸ’¡ Creating ~/.envrc with global flake config..."
        echo 'use flake ~/dotfiles/dev-env' > "$HOME/.envrc"
    fi

    echo "ğŸ” Allowing direnv for ~..."
    direnv allow ~
else
    echo "âš ï¸  direnv not found â€” skipping .envrc setup."
fi

echo "âœ… Bootstrap complete. You may want to restart your terminal or source ~/.zprofile."

